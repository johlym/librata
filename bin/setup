#!/usr/bin/env ruby
require 'fileutils'
require 'io/console'

# path to your application root.
APP_ROOT = File.expand_path('..', __dir__)

def system!(*args)
  log "Executing #{args}" 
  if system(*args)
    log "#{args} succeeded" 
  else
    log "#{args} failed"
    abort
  end 
end

def log(level = :info, msg)
  c = case level
  when :info
    '32'
  when :warn
    '38:5:208'
  when :error
    '31'
  when :debug
    '36'
  end

  puts "\e[#{c}m[ bin/setup ]\e[0m #{msg}"
end

def help
  log :help, '=== Things you might find helpful:'
  log :help, ''
  log :help, '  bin/setup'
  log :help, '      # set up the application'
  log :help, ''
  log :help, '  bin/ci'
  log :help, '      # test the application in CI fashion'
  log :help, ''
  log :help, '  bin/rails test'
  log :help, '      # runs non-system tests'
  log :help, ''
  log :help, '  bin/rails test:system'
  log :help, '      # runs system tests'
  log :help, ''
  log :help, '  bin/lint'
  log :help, '      # runs Rubocop to lint application code'
  log :help, ''
  log :help, '  bin/run'
  log :help, '      # starts the local development server'
  log :help, '      # prepend with LOGRAGE_IN_DEVELOPMENT=true for production'
  log :help, '          logging in development'
  log :help, ''
  log :help, '  bin/scan'
  log :help, '      # runs Brakeman to check for vulnerabilities'
  log :help, ''
  
end

def setup
  log :warn, 'This may reset your application. Are you sure? (Y/n)'
  return if STDIN.getch == "n"
  puts "\n"
  log :warn, "...and so it shall be."
  sleep 1
  
  log 'Installing Bundler'
  system! 'gem install bundler --conservative'

  log 'Installing gems'
  system! 'bundle check || bundle install'

  log 'Dropping & recreating the development database'
  system! 'bin/rails db:reset || bin/rails db:migrate'

  log 'Dropping & recreating the test database'
  system!({ 'RAILS_ENV' => 'test' }, 'bin/rails db:reset')

  log 'Clearing temporary files and logs'
  system! 'bin/rails log:clear tmp:clear'

  log 'Restarting the app server'
  system! 'bin/rails restart'

  log 'We\'re all set!' 
  log ''
  log 'For a list of commands, run:'
  log ''
  log '    bin/setup help'
  log ''
end

if ARGV[0] == "help" 
  help
else
  setup
end