#!/usr/bin/env ruby
require 'fileutils'
require 'io/console'

# path to your application root.
APP_ROOT = File.expand_path('..', __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

def log(level = :info, msg)
  c = case level
  when :info
    '32'
  when :warn
    '38:5:208'
  when :error
    '31'
  when :debug
    '36'
  end

  puts "\e[#{c}m[ bin/setup ] #{msg}\e[0m"
end

FileUtils.chdir APP_ROOT do
  # This script is a way to set up or update your development environment automatically.
  # This script is idempotent, so that you can run it at any time and get an expectable outcome.
  # Add necessary setup steps to this file.

  log :warn, 'This may reset your application. Press ENTER to continue, any other key to quit'
  return unless gets == "\n"

  log :warn, '...and so it shall be.'
  sleep 1
  
  log 'Installing Bundler'
  system! 'gem install bundler --conservative'

  log 'Installing gems'
  system! 'bundle check || bundle install'

  log :warn, 'test'
  log 'Dropping & recreating the development database'
  system! 'bin/rails db:reset || bin/rails db:migrate'

  log 'Dropping & recreating the test database'
  system!({ 'RAILS_ENV' => 'test' }, 'bin/rails db:reset')

  log 'Clearing temporary files and logs'
  system! 'bin/rails log:clear tmp:clear'

  log 'Restarting the app server'
  system! 'bin/rails restart'
end
